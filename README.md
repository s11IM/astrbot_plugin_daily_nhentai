# AstrBot NHentai Daily Plugin

这个插件会每日自动（或通过命令）获取 nhentai 的中文热门本子，并使用本地 YOLO NSFW 模型进行质量筛选。

## 功能特性
1. **自动爬取**: 绕过 Cf 获取每日热门列表，并自动过滤少于 35 页的短篇本子。
2. **本地筛选**: 下载本子所有图片，使用 YOLO 模型识别 NSFW 内容。
3. **智能评分**: 根据 NSFW 页面占比（如交合页/总页数）计算“CB指数”评分。
4. **精美卡片**: 生成包含封面、标签和评分的图片卡片。
5. **高度可配**: 支持自定义代理、模型阈值和推理设备，整体处理流程设置了20分钟超时保护。

## 安装步骤

### 1. 安装依赖
```bash
pip install -r requirements.txt
```
注意：安装 `ultralytics` 可能需要较长时间，因为它包含 PyTorch。建议使用支持 CUDA 的环境以获得最佳性能。

### 2. 下载 YOLO 模型
你需要自行下载一个预训练的 NSFW YOLO 模型（.pt 格式）。
**强烈推荐模型：**
*   **[erax-ai/EraX-NSFW-V1.0](https://huggingface.co/erax-ai/EraX-NSFW-V1.0)**
    *   请下载 **`erax_nsfw_yolo11m.pt`** (40.5MB)。这是我们在测试中实际使用的模型（准确率与召回率平衡）。
    *   如果你显存较小，也可以使用 `s` 或 `n` 版，但准确率会有所下降。

将下载好的 `.pt` 文件放入 `models/` 目录中。
例如：`astrbot_plugin_daily_nhentai/models/erax_nsfw_yolo11m.pt`

### 3. 配置插件
在 AstrBot 的插件管理页面中点击本插件的“配置”按钮：
*   **Proxy URL**: 填入你的代理地址【非必需】（例如 `http://127.0.0.1:7890`）。
*   **Model Threshold**: 调整 NSFW 检测的敏感度。
    *   **推荐值: 0.08**。这是经过测试得出的值，能够捕获大部分黑白漫画中的本番画面，同时保持较低的误报率。
    *   如果你希望只看极其露骨的画面，可以提高数值。
*   **Model Device**: 选择使用 CUDA 显卡还是 CPU 进行推理。

## 超时机制
插件内置了超时保护机制，防止任务长时间占用资源：
*   **整体超时**: 20分钟（`1200`秒）。如果整个流程（下载+分析）超过此时间，任务将自动中止。
*   **单本分析超时**: 5分钟（`300`秒）。单个本子的 AI 分析时间限制。

## 使用方法
在 AstrBot 中加载插件后，支持以下命令：

### 1. 获取今日热门
```
/nh today
```
Bot 将自动爬取 nhentai 中文热门列表，进行下载和 AI 分析，最后发送一张包含今日最佳 10 本的评分卡片。

### 2. 分析指定本子
```
/nh <本子ID>
```
例如：`/nh 123456`
Bot 将针对指定的本子 ID 进行下载和 AI 分析，并生成单张评分卡片。
